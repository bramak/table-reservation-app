<!DOCTYPE html>
<html>
  <head>
    <title>Restaraunts</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" type="text/css" href="style.css" />
  </head>
  <body>
    <div class="tab" id="mytab">
      <button class="hamburgermenu" onclick="tablinksdrop()">
        <img
          src="../../imageicondata/hamburger.png"
          width="20"
          height="20"
          class="price_tag"
        />
      </button>
      <div id="btn" class="filterButton">
        <div id="top"></div>
        <div id="middle"></div>
        <div id="bottom"></div>
      </div>
      <button class="tablinks" onclick="openpage(event, 'Restaraunts')">
        Restaraunts
      </button>
      <button class="tablinks" onclick="openpage(event, 'About-Us')">
        About US
      </button>
    </div>
    <div id="Restaraunts" class="tabcontent" id="defaultOpen">
      <!--   <button onclick="openNav()" class="hamburgermenu">Filter</button> -->
      <div id="empty"></div>
      <div id="headerdetails" class="flex-container"></div>
    </div>
    <div id="About-Us" class="tabcontent">About-Us</div>

    <div id="sideTab" class="sidetab">
      <a href="javascript:void(0)" class="closebtn" onclick="tablinksclose()"
        >Ã—</a
      >
      <ul class="no-bullets">
        <li>
          <button
            class="sidetablinks"
            onclick="openpage2(event, 'Restaraunts')"
            id="defaultOpen"
          >
            Restaraunts
          </button>
        </li>
        <li>
          <button class="sidetablinks" onclick="openpage2(event, 'About-Us')">
            About US
          </button>
        </li>
      </ul>
    </div>

    <!--filterpage-->
    <div id="box">
      <div id="items">
        <div class="item">
          <form>
            Select Filters<br />
            <label for="priceval"
              ><img
                src="../../imageicondata/price_tag.png"
                width="16"
                height="16"
                class="price_tag"
            /></label>
            <select name="priceval" id="priceval">
              <option value="6">6</option>
              <option value="5">5</option>
              <option value="2">4</option>
              <option value="3">3</option>
              <option value="4">2</option>
              <option value="1">1</option></select
            ><br />
            <label for="rating"
              ><img src="../../imageicondata/star.svg" width="16" height="16"
            /></label>
            <select name="rating" id="rating">
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
              <option value="6">6</option>
            </select>
            <label class="container"
              >Restaraunt Reservations
              <input
                type="checkbox"
                name="restaurantreservations"
                id="restaurantreservations"
              />
              <span class="checkmark"></span>
            </label>
            <label class="container"
              >Delivery
              <input type="checkbox" name="delivery" id="delivery" />
              <span class="checkmark"></span>
            </label>
            <label class="container"
              >Take Out
              <input type="checkbox" name="takeout" id="takeout" />
              <span class="checkmark"></span>
            </label>
            <label for="reviewsmin" class="labelsForDropdown">Reviews</label>
            <select name="reviewsmin" id="reviewsmin">
              <option value="0">0+</option>
              <option value="10">10+</option>
              <option value="50">50+</option>
              <option value="100">100+</option>
            </select>
            <button id="FilterResults" type="button" onclick="filterresults()">
              Filter Results
            </button>
          </form>
          <button
            id="clearFilters"
            type="button"
            onclick="window.location.reload()"
          >
            Clear Filters
          </button>
        </div>
      </div>
    </div>

<!--external script-->
    <script src="../../utils/detailsscripts.js"></script>

<!--other scripts-->    
    <script type="text/javascript">
      // List Element
      const ul = document.querySelector("#business");

      // API URL
      const url = "http://localhost:3001/business";


      //DOM's to get elements from filter form
      const deliveryFilterDOM = document.getElementById("delivery");
      const takeOutFilterDOM = document.getElementById("takeout");
      const reservationFilterDOM = document.getElementById(
        "restaurantreservations"
      );
      const pricevalFilterDOM = document.getElementById("priceval");
      const ratingFilterDOM = document.getElementById("rating");
      const reviewsminFilterDOM = document.getElementById("reviewsmin");

      const tileRootDOM = document.getElementById("headerdetails");

      //text to display when there are no results after filter
      const emptytiles = `<div><h2>There are no results that match this search.</h2></div>`;

      //rendering tiles
      const renderTiles = (data) => {
        // iterate over items
        const listitems = data.forEach((item) => {
          // create the elements
          const tile = `
              <div class="tile">
                    <div class="mainbox">
                    <div class="imgclass"><img class="image" src="${item.thumbnail}" alt="${item.name}"  onerror=this.src="../../imageicondata/food.png" /></div>
                    <div class="overlay"></div>
                    <div class="buttonoverlay">
                    <div class="restname">${item.name}</div>
                    <div class="ratingbox">
                    <img src="../../imageicondata/star.svg" width="16" height="16" /> ${item.stars}
                    </div>
                    </div>
                    </div>
                    <form action="../restaraunt-descriptions/index.html#/${item.business_id}">
                    <div class="bottommain">
                    <button type="submit" class="button">View Details</button></form>
                    </div>
            </div>
            `;
          document
            .getElementById("headerdetails")
            .appendChild(createElementFromHTML(tile));
        });
      };

      // make the API call

      function getData() {
        return fetch(url)
          .then((res) => res.json())
          .catch((err) => {
            console.error("Error: ", err);
          });
      }

      getData().then((data) => {
        renderTiles(data);
      });

      // default open restaraunt list when loaded or click to open the restaraunt list tab
      document.getElementById("defaultOpen").click();

      //menu
      function tablinksdrop() {
        document.getElementById("sideTab").style.width = "150px";
        document.getElementById("main").style.marginLeft = "150px";
      }

      function tablinksclose() {
        document.getElementById("sideTab").style.width = "0";
        document.getElementById("main").style.marginLeft = "0";
      }


      //filter results
      function filterresults() {
        //if existing: to clear previous no results message 
        empty.innerHTML = "";

        // parameters receving value from form
        const allFilterOptions = {
          RestaurantsDelivery: deliveryFilterDOM.checked,
          RestaurantsTakeOut: takeOutFilterDOM.checked,
          RestaurantsReservations: reservationFilterDOM.checked,
          maxPriceRange: parseInt(pricevalFilterDOM.value),
          stars: parseInt(ratingFilterDOM.value),
          review_count: parseInt(reviewsminFilterDOM.value),
        };

        // to consider only selected options in form
        const chosenFilterOptions = Object.keys(allFilterOptions).reduce(
          (acc, key) => {
            if (typeof allFilterOptions[key] === "boolean") {
              if (allFilterOptions[key] === true) {
                return { ...acc, [key]: true };
              } else {
                return acc;
              }
            } else {
              return { ...acc, [key]: allFilterOptions[key] };
            }
          },
          {}
        );

        //fetching results
        getData().then((data) => {
          const filteredResults = data.filter((item) => {
            const {
              RestaurantsDelivery = "False",
              RestaurantsTakeOut = "False",
              RestaurantsReservations = "False",
              RestaurantsPriceRange2 = 6,
            } = item.attributes;
            const { stars = 1, review_count = 0 } = item;
            const filterParams = {
              RestaurantsDelivery: converttobool(RestaurantsDelivery),
              RestaurantsTakeOut: converttobool(RestaurantsTakeOut),
              RestaurantsReservations: converttobool(RestaurantsReservations),
              RestaurantsPriceRange2,
              stars,
              review_count,
            };
            let result = true;
            //counting params with true or number value
            Object.keys(chosenFilterOptions).forEach((key) => {
              if (typeof chosenFilterOptions[key] === "boolean") {
                if (filterParams[key] === false) {
                  result = false;
                }
              } else if (typeof chosenFilterOptions[key] === "number") {
                if (filterParams[key] <= chosenFilterOptions[key]) {
                  result = false;
                }
              }
            });
            return result;
          });

          //clearing previous display
          tileRootDOM.innerHTML = "";

          console.log(filteredResults);

          //rendering final display
          renderTiles(filteredResults);
          if (filteredResults.length == 0) {
            document
              .getElementById("empty")
              .appendChild(createElementFromHTML(emptytiles));
          }
          document.getElementById("btn").click();
          document.getElementById("defaultOpen").click();
        });
      }

      //filtersidebar

      var sidebarBox = document.querySelector("#box");
      var sidebarBtn = document.querySelector("#btn");
      var pageWrapper = document.querySelector("#main-content");

      sidebarBtn.addEventListener("click", function (event) {
        if (this.classList.contains("active")) {
          this.classList.remove("active");
          sidebarBox.classList.remove("active");
        } else {
          this.classList.add("active");
          sidebarBox.classList.add("active");
        }
      });

      pageWrapper.addEventListener("click", function (event) {
        if (sidebarBox.classList.contains("active")) {
          sidebarBtn.classList.remove("active");
          sidebarBox.classList.remove("active");
        }
      });

      window.addEventListener("keydown", function (event) {
        if (sidebarBox.classList.contains("active") && event.keyCode === 27) {
          sidebarBtn.classList.remove("active");
          sidebarBox.classList.remove("active");
        }
      });
    </script>
  </body>
</html>
